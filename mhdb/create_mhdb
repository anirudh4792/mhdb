#!/usr/bin/env python
"""
This is a program to convert a mental health spreadsheet to RDF.

Authors:
    - Arno Klein, 2017  (arno@childmind.org)  http://binarybottle.com

Copyright 2017, Child Mind Institute (http://childmind.org), Apache v2.0 License

"""
import os
import argparse
import numpy as np
import pandas as pd
#import rdflib

from mhdb.info import __version__ as version
from mhdb.info import long_description as comment
from mhdb.info import description as label
from mhdb.owl_boilerplate import convert_string_to_label, create_label, \
    get_index2, get_cell, build_rdf, print_header, print_subheader, \
    print_general_axioms

# ------------------------------------------------------------------------------
# Command-line arguments
# ------------------------------------------------------------------------------
debug = True
if debug:
    FILE = '/data/mentalhealth.xlsx'
    base_uri = "http://www.purl.org/mentalhealth"
    outfile = os.path.join(os.getcwd(), 'mhdb.ttl')
else:
    parser = argparse.ArgumentParser(description="""
                This program converts a mental health spreadsheet to RDF.""",
                                     formatter_class = lambda prog:
                                     argparse.HelpFormatter(prog,
                                                            max_help_position=40))
    rec_args = parser.add_argument_group('recommended arguments')

    # "positional arguments":
    parser.add_argument("FILE", help=("spreadsheet file path"))
    # "optional arguments":
    parser.add_argument("-b", "--base_uri", help="name of base URL",
                        default='http://purl.com/mentalhealth', metavar='STR')
    parser.add_argument("-o", "--outfile", help="name of output file",
                        default=os.path.join(os.getcwd(), 'mhdb.ttl'),
                        metavar='STR')
    args = parser.parse_args()
    FILE = args.FILE
    base_uri = args.base_uri

# ------------------------------------------------------------------------------
# Import spreadsheet
# ------------------------------------------------------------------------------
xls = pd.ExcelFile(FILE)
X = ['', 'nan', np.nan, 'None', None]

# ------------------------------------------------------------------------------
# Create output RDF file and print header
# ------------------------------------------------------------------------------
fid = open(outfile, 'w')
header_string = print_header(base_uri, version, label, comment)
fid.write(header_string)

# ------------------------------------------------------------------------------
# Extract worksheets as pandas dataframes
# ------------------------------------------------------------------------------
#sheet_names = xls.sheet_names
#for sheet_name in sheet_names:
#    exec("{0} = xls.parse('{0}')".format(sheet_name))
Classes = xls.parse("Classes")
Properties = xls.parse("Properties")
Level0 = xls.parse("DisorderCategory")
Level1 = xls.parse("DisorderSubcategory")
Level2 = xls.parse("DisorderSubsubcategory")
Level3 = xls.parse("DisorderSubsubsubcategory")
Disorder = xls.parse("Disorder")
Severity = xls.parse("DisorderSeverity")
Specifier = xls.parse("DiagnosticSpecifier")
Criterion = xls.parse("DiagnosticCriterion")
SymptomCat = xls.parse("SignOrSymptomCategory")
Symptom = xls.parse("SignOrSymptom")
Questionnaire = xls.parse("Questionnaire")
Question = xls.parse("Question")
QuestionCat = xls.parse("QuestionCategory")
AnswerType = xls.parse("AnswerType")
Reference = xls.parse("Reference")
ReferenceType = xls.parse("ReferenceType")

# ------------------------------------------------------------------------
# Properties and triples
# ------------------------------------------------------------------------
fid.write(print_subheader('Properties'))

for index, label in enumerate(Properties.PropertyName):
    label_safe = convert_string_to_label(label)
    rdf_string = build_rdf(uri_stem=label_safe,
                           rdf_type='owl:ObjectProperty',
                           label=label,
                           comment=None,
                           index=index,
                           worksheet=Properties,
                           worksheet2=Reference,
                           equivalent_class_uri=None,
                           subclassof_uri=None,
                           property_domain=None,
                           property_range=None,
                           exclude=X)
    fid.write(rdf_string)
    exec("{0}_uri = ':{0}'".format(label_safe))

# ------------------------------------------------------------------------
# Classes and triples
# ------------------------------------------------------------------------
fid.write(print_subheader('Classes'))

for index, label in enumerate(Classes.ClassName):
    label_safe = convert_string_to_label(label)
    rdf_string = build_rdf(uri_stem=label_safe,
                           rdf_type='owl:Class',
                           label=label,
                           comment=None,
                           index=index,
                           worksheet=Classes,
                           worksheet2=Reference,
                           equivalent_class_uri=None,
                           subclassof_uri=None,
                           property_domain=None,
                           property_range=None,
                           exclude=X)
    fid.write(rdf_string)
    exec("{0}_uri = ':{0}'".format(label_safe))

fid.write("\n{0} {1} {2}\n".format(MentalDisorder_uri, 'rdfs:subClassOf', Disorder_uri))

# ----------------------------------------------------------------------------
# Disorder-related classes and triples
# ----------------------------------------------------------------------------
fid.write(print_subheader('Disorder classes and triples'))

label_list = []
sheet1 = Disorder
sheets2 = [Level0, Level1, Level2, Level3, Severity, Specifier,
           Criterion, Criterion, Criterion, Criterion]
column1_headers = ['DisorderCategory_index',
                   'DisorderSubcategory_index',
                   'DisorderSubsubcategory_index',
                   'DisorderSubsubsubcategory_index',
                   'DisorderSeverity_index',
                   'DiagnosticSpecifier_index',
                   'DiagnosticInclusionCriterion_index',
                   'DiagnosticInclusionCriterion2_index',
                   'DiagnosticExclusionCriterion_index',
                   'DiagnosticExclusionCriterion2_index']
name_headers = ['DisorderCategoryName', 'DisorderSubcategoryName',
                'DisorderSubsubcategoryName', 'DisorderSubsubsubcategoryName',
                'DisorderSeverityName', 'DiagnosticSpecifierName',
                'DiagnosticCriterionName', 'DiagnosticCriterionName',
                'DiagnosticCriterionName', 'DiagnosticCriterionName']

# Loop through Disorders:
for iD, disorder in enumerate(Disorder.DisorderName):
    if disorder not in X:

        # ICD-10 code:
        #print(get_cell(Disorder, 'ICD10code', iD))
        ICD10_uri = "http://purl.bioontology.org/ontology/ICD10CM/" #+ \
                        #get_cell(Disorder, 'ICD10code', iD)

        # Indices to rows in Disorder-related worksheets:
        ilvl0 = get_index2(sheet1, column1_headers[0], iD, sheets2[0], X)
        ilvl1 = get_index2(sheet1, column1_headers[1], iD, sheets2[1], X)
        ilvl2 = get_index2(sheet1, column1_headers[2], iD, sheets2[2], X)
        ilvl3 = get_index2(sheet1, column1_headers[3], iD, sheets2[3], X)
        isevr = get_index2(sheet1, column1_headers[4], iD, sheets2[4], X)
        ispec = get_index2(sheet1, column1_headers[5], iD, sheets2[5], X)
        incl1 = get_index2(sheet1, column1_headers[6], iD, sheets2[6], X)
        incl2 = get_index2(sheet1, column1_headers[7], iD, sheets2[7], X)
        ixcl1 = get_index2(sheet1, column1_headers[8], iD, sheets2[8], X)
        ixcl2 = get_index2(sheet1, column1_headers[9], iD, sheets2[9], X)

        # Unique labels and URIs:
        disorder, disorder_ok = create_label(disorder)
        disorder_uri = ":{0}".format(disorder_ok)
        try:
            level0, level0_ok = create_label(get_cell(sheets2[0], name_headers[0], ilvl0))
            level0_uri = ":{0}".format(level0_ok)
        except:
            level0, level0_ok, level0_uri = None, None, None
        try:
            level1, level1_ok = create_label(get_cell(sheets2[1], name_headers[1], ilvl1))
            level1_uri = ":{0}".format(level1_ok)
        except:
            level1, level1_ok, level1_uri = None, None, None
        try:
            level2, level2_ok = create_label(get_cell(sheets2[2], name_headers[2], ilvl2))
            level2_uri = ":{0}".format(level2_ok)
        except:
            level2, level2_ok, level2_uri = None, None, None
        try:
            level3, level3_ok = create_label(get_cell(sheets2[3], name_headers[3], ilvl3))
            level3_uri = ":{0}".format(level3_ok)
        except:
            level3, level3_ok, level3_uri = None, None, None
        try:
            severity, severity_ok = create_label(get_cell(sheets2[4], name_headers[4], isevr))
            severity_uri = ":{0}".format(severity_ok)
        except:
            severity, severity_ok, severity_uri = None, None, None
        try:
            specifier, specifier_ok = create_label(get_cell(sheets2[5], name_headers[5], ispec))
            specifier_uri = ":{0}".format(specifier_ok)
        except:
            specifier, specifier_ok, specifier_uri = None, None, None
        try:
            include1, include1_ok = create_label(get_cell(sheets2[6], name_headers[6], incl1))
            include1_uri = ":{0}".format(include1_ok)
        except:
            include1, include1_ok, include1_uri = None, None, None
        try:
            include2, include2_ok = create_label(get_cell(sheets2[7], name_headers[7], incl2))
            include2_uri = ":{0}".format(include2_ok)
        except:
            include2, include2_ok, include2_uri = None, None, None
        try:
            exclude1, exclude1_ok = create_label(get_cell(sheets2[8], name_headers[8], ixcl1))
            exclude1_uri = ":{0}".format(exclude1_ok)
        except:
            exclude1, exclude1_ok, exclude1_uri = None, None, None
        try:
            exclude2, exclude2_ok = create_label(get_cell(sheets2[9], name_headers[9], ixcl2))
            exclude2_uri = ":{0}".format(exclude2_ok)
        except:
            exclude2, exclude2_ok, exclude2_uri = None, None, None

        # Loop through Disorder-related variables:
        indices = [ilvl0, ilvl1, ilvl2, ilvl3, iD, isevr, ispec,
                   incl1, incl2, ixcl1, ixcl2]
        labels = [level0, level1, level2, level3, disorder, severity, specifier,
                  include1, include2, exclude1, exclude2]
        labels_ok = [level0_ok, level1_ok, level2_ok, level3_ok, disorder_ok,
                     severity_ok, specifier_ok,
                     include1_ok, include2_ok, exclude1_ok, exclude2_ok]
        uris = [level0_uri, level1_uri, level2_uri, level3_uri, disorder_uri,
                severity_uri, specifier_uri,
                include1_uri, include2_uri, exclude1_uri, exclude2_uri]
        equivalentclasses = [None, None, None, None, ICD10_uri,
                             None, None, None, None, None, None]
        subclassofs = [MentalDisorder_uri, level0_uri, level1_uri, level2_uri,
                       None, None, None, None, None, None, None]
        nlabels = len(labels)
        for i in range(nlabels):
            if indices[i]:

                # subClassOf is direct upper level (disorder is any upper level):
                superclass = None
                if i < nlabels:
                    subclassof = subclassofs[i]
                    if subclassof not in X:
                        superclass = subclassof
                else:
                    subclassof = superclass

                # Build rdf string if new and unique label:
                label_ok = labels_ok[i]
                if label_ok not in X and label_ok not in label_list:
                    label_list.append(label_ok)
                    rdf_string = build_rdf(uri_stem=label_ok,
                                           rdf_type='owl:Class',
                                           label=labels[i],
                                           comment=None,
                                           index=indices[i],
                                           worksheet=sheets2[i],
                                           worksheet2=Reference,
                                           equivalent_class_uri=equivalentclasses[i],
                                           subclassof_uri=subclassof,
                                           property_domain=None,
                                           property_range=None,
                                           exclude=X)
                    fid.write(rdf_string)

                    # --------------------------------------------------------
                    # Disorder-related triples
                    # --------------------------------------------------------
                    if severity_uri:
                        fid.write("\n{0} {1} {2}\n".format(disorder_uri,
                                                         hasSeverity_uri,
                                                         severity_uri))
                    if specifier_uri:
                        fid.write("\n{0} {1} {2}\n".format(disorder_uri,
                                                         hasDiagnosticSpecifier_uri,
                                                         specifier_uri))
                    if include1_uri:
                        fid.write("\n{0} {1} {2}\n".format(disorder_uri,
                                                         hasInclusionCriterion_uri,
                                                         include1_uri))
                    if include2_uri:
                        fid.write("\n{0} {1} {2}\n".format(disorder_uri,
                                                         hasInclusionCriterion_uri,
                                                         include2_uri))
                    if exclude1_uri:
                        fid.write("\n{0} {1} {2}\n".format(disorder_uri,
                                                         hasExclusionCriterion_uri,
                                                         exclude1_uri))
                    if exclude2_uri:
                        fid.write("\n{0} {1} {2}\n".format(disorder_uri,
                                                         hasExclusionCriterion_uri,
                                                         exclude2_uri))

# ----------------------------------------------------------------------------
# Symptom-related classes and triples
# ----------------------------------------------------------------------------
fid.write(print_subheader('Symptom classes and triples'))
#           SymptomCat, Symptom,
#           Questionnaire, Question, QuestionCat, AnswerType,
#           Reference, ReferenceType]

# Loop through Symptoms:
sheets2 = [Symptom, SymptomCat]
for iS, symptom in enumerate(Symptom.SymptomName):
    if symptom not in X:

        # Indices to rows in Symptom-related worksheets:
        isymcat = get_index2(Symptom, 'SymptomCategory_index', iS, SymptomCat, X)
        idisorder_symcat = get_index2(SymptomCat, 'Disorder_index', isymcat,
                                      Disorder, X)

        # Unique labels and URIs:
        symptom, symptom_ok = create_label(get_cell(Symptom, 'SymptomName', iS))
        symptom_uri = ":{0}".format(symptom_ok)
        try:
            symptomcat, symptomcat_ok = create_label(
                get_cell(SymptomCat, 'SymptomCategoryName', isymcat))
            symptomcat_uri = ":{0}".format(symptomcat_ok)
        except:
            symptomcat, symptomcat_ok, symptomcat_uri = None, None, None
        try:
            disorder_for_symptom, disorder_for_symptom_ok = create_label(
                get_cell(Disorder.DisorderName[idisorder_symcat]))
            disorder_for_symptom_uri = ":{0}".format(disorder_for_symptom_ok)
        except:
            disorder_for_symptom, disorder_for_symptom_ok, disorder_for_symptom_uri = None, None, None

        # Loop through Symptom-related classes:
        indices = [iS, isymcat]
        labels = [symptom, symptomcat]
        labels_ok = [symptom_ok, symptomcat_ok]
        uris = [symptom_uri, symptomcat_uri]
        equivalentclasses = [None, None]
        subclassofs = [symptomcat_uri, None]
        nlabels = len(labels)
        for i in range(nlabels):
            if indices[i]:

                # Build rdf string if new and unique label:
                label_ok = labels_ok[i]
                if label_ok not in X and label_ok not in label_list:
                    label_list.append(label_ok)
                    rdf_string = build_rdf(uri_stem=label_ok,
                                           rdf_type='owl:Class',
                                           label=labels[i],
                                           comment=None,
                                           index=indices[i],
                                           worksheet=sheets2[i],
                                           worksheet2=Reference,
                                           equivalent_class_uri=equivalentclasses[i],
                                           subclassof_uri=subclassofs[i],
                                           property_domain=None,
                                           property_range=None,
                                           exclude=X)
                    fid.write(rdf_string)

                    # --------------------------------------------------------
                    # Symptom-related triples
                    # --------------------------------------------------------
                    if symptomcat_uri:
                        fid.write("\n{0} {1} {2}\n".format(symptomcat_uri,
                                                         'rdfs:subClassOf',
                                                         SignOrSymptom_uri))
                        fid.write("\n{0} {1} {2}\n".format(disorder_for_symptom_uri,
                                                         hasSymptom_uri,
                                                         symptomcat_uri))
                        fid.write("\n{0} {1} {2}\n".format(symptom_uri,
                                                         'rdfs:subClassOf',
                                                         SignOrSymptomCategory_uri))
                    else:
                        fid.write("\n{0} {1} {2}\n".format(symptom_uri,
                                                         'rdfs:subClassOf',
                                                         SignOrSymptom_uri))

# ----------------------------------------------------------------------------
# Questions/questionnaire classes
# ----------------------------------------------------------------------------
fid.write(print_subheader('Question classes and triples'))

# Loop through Questions:
sheets2 = [Question, Question, AnswerType, AnswerType,
           QuestionCat, Questionnaire]
rdf_types = [Question_uri, Question_uri, 'owl:Class', 'owl:Class',
             'owl:Class', Questionnaire_uri]
for iQ, question in enumerate(Question.QuestionText):
    if question not in X:

        # Indices to rows in Question-related worksheets:
        ians1type = get_index2(Question, 'AnswerType_index', iQ, AnswerType, X)
        ians2type = get_index2(Question, 'Answer2Type_index', iQ, AnswerType, X)
        iqcat = get_index2(Question, 'QuestionCategory_index', iQ, QuestionCat, X)
        iqstnr = get_index2(Question, 'Reference_index', iQ, Reference, X)

        # Unique labels and URIs:
        question, question_ok = create_label(question)
        question_uri = ":{0}".format(question_ok)
        try:
            question2, question2_ok = create_label(get_cell(Question, 'Question2Text', iQ))
            question2_uri = ":{0}".format(question2_ok)
        except:
            question2, question2_ok, question2_uri = None, None, None
        try:
            answertype, answertype_ok = create_label(
                get_cell(AnswerType, 'AnswerTypeName', ians1type))
            answertype_uri = ":{0}".format(answertype_ok)
        except:
            answertype, answertype_ok, answertype_ok = None, None, None
        try:
            answer2type, answer2type_ok = create_label(
                get_cell(AnswerType, 'AnswerTypeName', ians2type))
            answer2type_uri = ":{0}".format(answer2type_ok)
        except:
            answer2type, answer2type_ok, answer2type_uri = None, None, None
        try:
            questioncat, questioncat_ok = create_label(
                get_cell(QuestionCat, 'QuestionCategoryName', iqcat))
            questioncat_uri = ":{0}".format(questioncat_ok)
        except:
            questioncat, questioncat_ok, questioncat_uri = None, None, None
        try:
            questionnaire, questionnaire_ok = create_label(
                get_cell(Reference, 'ReferenceName', iqstnr))
            questionnaire_uri = ":{0}".format(questionnaire_ok)
        except:
            questionnaire, questionnaire_ok, questionnaire_uri = None, None, None

        # Loop through Question-related classes:
        indices = [iQ, iQ, ians1type, ians2type, iqcat, iqstnr]
        labels = [question, question2, answertype, answer2type,
                  questioncat, questionnaire]
        labels_ok = [question_ok, question2_ok, answertype_ok, answer2type_ok,
                     questioncat_ok, questionnaire_ok]
        uris = [question_uri, question2_uri, answertype_uri, answer2type_uri,
                questioncat_uri, questionnaire_uri]
        equivalentclasses = [None, None, None, None, None, None]
        subclassofs = [None, None, AnswerType_uri, AnswerType_uri, None, None]
        nlabels = len(labels)
        for i in range(nlabels):
            if indices[i]:

                # Build rdf string if new and unique label:
                label_ok = labels_ok[i]
                if label_ok not in X and label_ok not in label_list:
                    label_list.append(label_ok)
                    rdf_string = build_rdf(uri_stem=label_ok,
                                           rdf_type=rdf_types[i],
                                           label=labels[i],
                                           comment=None,
                                           index=indices[i],
                                           worksheet=sheets2[i],
                                           worksheet2=Reference,
                                           equivalent_class_uri=equivalentclasses[i],
                                           subclassof_uri=subclassofs[i],
                                           property_domain=None,
                                           property_range=None,
                                           exclude=X)
                    fid.write(rdf_string)

                    # --------------------------------------------------------
                    # Question-related triples
                    # --------------------------------------------------------
                    fid.write("\n{0} {1} {2}\n".format(question_uri,
                                                     'rdfs:type',
                                                     Question_uri))
                    if answertype_uri:
                        fid.write("\n{0} {1} {2}\n".format(question_uri,
                                                         hasAnswerType_uri,
                                                         answertype_uri))
                        fid.write("\n{0} {1} {2}\n".format(answertype_uri,
                                                         'rdfs:type',
                                                         AnswerType_uri))
                    if question2_uri:
                        fid.write("\n{0} {1} {2}\n".format(question_uri,
                                                         hasFollowupQuestion_uri,
                                                         question2_uri))
                        fid.write("\n{0} {1} {2}\n".format(question2_uri,
                                                         'rdfs:type',
                                                         Question_uri))
                        if answer2type_uri:
                            fid.write("\n{0} {1} {2}\n".format(question2_uri,
                                                             hasAnswerType_uri,
                                                             answer2type_uri))
                            fid.write("\n{0} {1} {2}\n".format(answer2type_uri,
                                                             'rdfs:type',
                                                             AnswerType_uri))
                    if questioncat_uri:
                        fid.write("\n{0} {1} {2}\n".format(question_uri,
                                                         typeOf_uri,
                                                         QuestionCategory_uri))
                        fid.write("\n{0} {1} {2}\n".format(questioncat_uri,
                                                         'rdfs:type',
                                                         QuestionCategory_uri))
                    if questionnaire_uri:
                        fid.write("\n{0} {1} {2}\n".format(question_uri,
                                                         containedWithin_uri,
                                                         questionnaire_uri))
                        fid.write("\n{0} {1} {2}\n".format(questionnaire_uri,
                                                         'rdfs:type',
                                                         Questionnaire_uri))

# ----------------------------------------------------------------------------
# Reference classes and triples
# ----------------------------------------------------------------------------
fid.write(print_subheader('Reference classes and triples'))

# Loop through References:
sheet1 = Reference
sheets2 = [Reference, ReferenceType]
sheets3 = [None, Reference]
rdf_types = [Reference_uri, 'owl:Class']
for iR, reference in enumerate(Reference.ReferenceName):

    ireftype = Reference.ReferenceType_index.iloc[[iR][0]]
    index = pd.Index(ReferenceType['index']).get_loc(ireftype)
    label, label_safe = create_label(ReferenceType.ReferenceTypeName[index])


    # Indices to rows in Symptom-related worksheets:
    ireftype = get_index2(Reference, 'ReferenceType_index', iR, ReferenceType, X)

    # Unique labels and URIs:
    reference, reference_ok = create_label(reference)
    reference_uri = ":{0}".format(reference_ok)
    try:
        referencetype, referencetype_ok = create_label(
            get_cell(ReferenceType, 'ReferenceTypeName', ireftype))
        referencetype_uri = ":{0}".format(referencetype_ok)
    except:
        referencetype, referencetype_ok, referencetype_uri = None, None, None

    # Loop through Reference-related classes:
    indices = [iR, ireftype]
    labels = [reference, referencetype]
    labels_ok = [reference_ok, referencetype_ok]
    equivalentclasses = [None, None]
    subclassofs = [None, ReferenceType_uri]
    nlabels = len(labels)
    for i in range(nlabels):
        if indices[i]:

            # Build rdf string if new and unique label:
            label_ok = labels_ok[i]
            if label_ok not in X and label_ok not in label_list:
                label_list.append(label_ok)
                rdf_string = build_rdf(uri_stem=label_ok,
                                       rdf_type=rdf_types[i],
                                       label=labels[i],
                                       comment=None,
                                       index=indices[i],
                                       worksheet=sheets2[i],
                                       worksheet2=sheets3[i],
                                       equivalent_class_uri=equivalentclasses[i],
                                       subclassof_uri=subclassofs[i],
                                       property_domain=None,
                                       property_range=None,
                                       exclude=X)
                fid.write(rdf_string)

    # ------------------------------------------------------------------------
    # Reference-related triples
    # ------------------------------------------------------------------------
    fid.write("\n{0} {1} {2}\n".format(reference_uri, 'rdfs:type',
                                       Reference_uri))

# ----------------------------------------------------------------------------
# General axioms
# ----------------------------------------------------------------------------
#fid.write(print_subheader('General axioms'))
#general_axioms_string = print_general_axioms(disjoint_classes_list=[])
#fid.write(general_axioms_string)

# ============================================================================
# Doctests
# ============================================================================
#if __name__ == "__main__":
#    import doctest
#    doctest.testmod(verbose=True)
